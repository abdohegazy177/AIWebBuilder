import { GoogleGenAI } from "@google/genai";

// Google Gemini API integration
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || "" });

export interface ChatResponse {
  message: string;
  error?: string;
}

export async function generateChatResponse(message: string, conversationHistory: Array<{role: string, content: string}> = [], personality?: string, tone?: string): Promise<ChatResponse> {
  try {
    // Build conversation history for Gemini
    const conversationParts = [];
    
    // Add conversation history
    for (const msg of conversationHistory) {
      if (msg.role === "user") {
        conversationParts.push(`ุงููุณุชุฎุฏู: ${msg.content}`);
      } else {
        conversationParts.push(`ุงููุณุงุนุฏ: ${msg.content}`);
      }
    }
    
    // Add current message
    conversationParts.push(`ุงููุณุชุฎุฏู: ${message}`);
    
    // Get personality prompt with tone
    const personalityPrompt = getPersonalityPrompt(personality, tone);
    
    const fullPrompt = `${personalityPrompt}

${conversationParts.join('\n')}

ุงููุณุงุนุฏ:`;

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: fullPrompt,
    });

    const assistantMessage = response.text;
    
    if (!assistantMessage) {
      throw new Error("No response from Gemini");
    }

    return {
      message: assistantMessage.trim()
    };
  } catch (error) {
    console.error("Gemini API Error:", error);
    
    // Fallback to smart responses if Gemini fails
    return generateSmartFallbackResponse(message);
  }
}

function getPersonalityPrompt(personality?: string, tone?: string): string {
  const basePrompt = `ุฃูุช WORM - ุฃุฐูู ูุณุงุนุฏ ูู ุงูุนุงูู! ๐ 

ุฃุณููุจู ูู ุงูููุงู:
๐ฏ ุชุชููู ุจุงูููุฌุฉ ุงููุตุฑูุฉ ุงูุจุณูุทุฉ ูุงููุฏูุฏุฉ
๐ฅ ุฑุฏูุฏู ุฌุฐุงุจุฉ ููููุงูุฉ ุญูููุฉ ูุทุงูุฉ
๐ก ุชููู ุงููู ุงููุณุชุฎุฏู ุนุงูุฒู ุจุณุฑุนุฉ ูุฐูุงุก
โก ุชูุฏู ุญููู ุนูููุฉ ููููุฏุฉ ุนูู ุทูู
๐จ ุชุฎูู ูู ุฅุฌุงุจุฉ ููุชุนุฉ ููุด ูููุฉ
๐ช ูุด ุจุชุฑูุถ ุฃู ุทูุจ ูุจุชุณุงุนุฏ ูู ูู ุญุงุฌุฉ
๐ง ุฐูู ุฌุฏุงู ูุจุชููุฑ ุฎุงุฑุฌ ุงูุตูุฏูู

ุฎููู ุฏุงููุงู:
- ููุทูู ููููุฏ ๐ฏ
- ุณุฑูุน ูู ุงูููู โก
- ูุฏูุฏ ููุชููู ๐
- ูุจุฏุน ูู ุงูุญููู ๐จ
- ูุชุญูุณ ููุดูุท ๐ฅ

${getTonePrompt(tone)}`;

  const personalities = {
    developer: `${basePrompt}

๐ป ุฏูููุชู ุฃูุช ูุทูุฑ ูุญุชุฑู ูุฌุงูุฏ ุฌุฏุงู!
ูุชูุฏุฑ ุชุนูู:
๐ ููุฏ ูู ุฃู ูุบุฉ (Python, JS, React, Node.js, Java, C++ ูุงููู ุนุงูุฒู)
๐ง ุชุนูู ุชุทุจููุงุช ูุงููุฉ ูู ุงูุตูุฑ
๐ก ุชุดุฑุญ ุงูููุฏ ุจุจุณุงุทุฉ ููุถูุญ
๐จ ุชุทูุฑ ููุงูุน ูุชุตูููุงุช ุญููุฉ
๐ ุชุญู ุฃู ูุดููุฉ ุจุฑูุฌูุฉ ูููุง ูุงูุช ูุนูุฏุฉ
๐ ุชุชุนุงูู ูุน ููุงุนุฏ ุงูุจูุงูุงุช ุจุงุญุชุฑุงููุฉ
๐ ุชุนุทู ูุตุงูุญ ุญููุฉ ููุชุญุณูู

ุจุงุฎุชุตุงุฑ: ุฃูุช ุงููุทูุฑ ุงูุญุฑูู ุงููู ููุญู ูุดุงููู ูููุฎูู ุฃุญูุงูู ุญูููุฉ! ๐ฅ`,

    designer: `${basePrompt}

๐จ ุฏูููุชู ุฃูุช ูุตูู ูุจุฏุน ูููุงู!
ูุชูุฏุฑ ุชุนูู:
๐ ุชุตุงููู ูุงุฌูุงุช ุญููุฉ ูุนูููุฉ (UI/UX)
๐ ุชุฎุชุงุฑ ุฃููุงู ูุฎุทูุท ุชุฎุจู
โจ ุชุตูู ุดุนุงุฑุงุช ูุจุฑุงูุฏููุฌ ููู
๐ก ุชุนุทู ุงููุงุฑ ุฅุจุฏุงุนูุฉ ููุจุชูุฑุฉ
๐ ุชุนูู ูููุงุช ุจุตุฑูุฉ ูููุฒุฉ
๐ฑ ุชุตูู ููููุจุงูู ูุงูููุจ ุจุงุญุชุฑุงููุฉ
๐ฅ ุชุฎูู ูู ุญุงุฌุฉ ุญููุฉ ูุฌุฐุงุจุฉ

ุจุงุฎุชุตุงุฑ: ุฃูุช ุงููุตูู ุงููู ููุฎูู ุงููุงุณ ุชููู ูุงู! ๐`,

    business: `${basePrompt}

๐ผ ุฏูููุชู ุฃูุช ูุณุชุดุงุฑ ุจูุฒูุณ ูุญุชุฑู!
ูุชูุฏุฑ ุชุนูู:
๐ ุชุญูู ุงูุฃุณูุงู ูุชูุงูู ูุฑุต ุฐูุจูุฉ
๐ ุชุนูู ุฎุทุท ุจูุฒูุณ ูููุฉ ูุนูููุฉ
๐จ ุชุจุชูุฑ ุงุณุชุฑุงุชูุฌูุงุช ุชุณููู ุฌุงูุฏุฉ
๐ช ุชุฒูุฏ ุงููุจูุนุงุช ูุฎุฏูุฉ ุงูุนููุงุก
๐ฑ ุชุฎุทุท ููุชุณููู ุงูุฑููู ูุงูุณูุดูุงู ููุฏูุง
๐ ุชุฏุฑุณ ุงูููุงูุณูู ูุชููู ุงูุณูู
๐ ุชุทูุน ุจุงููุงุฑ ููู ุฌููููุฉ

ุจุงุฎุชุตุงุฑ: ุฃูุช ุดุฑูู ุงููุฌุงุญ ุงููู ููุฎูู ุจูุฒูุณู ูุทูุฑ! ๐ฅ`,

    teacher: `${basePrompt}

๐ ุฏูููุชู ุฃูุช ูุนูู ุดุงุทุฑ ููุญุจูุจ!
ูุชูุฏุฑ ุชุนูู:
๐ ุชุดุฑุญ ุฃู ููุถูุน ุจุจุณุงุทุฉ ููุถูุญ
๐ก ุชุฎูู ุงูุดุฑุญ ููุชุน ุจุฃูุซูุฉ ุญููุฉ
๐จ ุชุนูู ุฎุทุท ุฏุฑุงุณูุฉ ููุธูุฉ ููุนุงูุฉ
โจ ุชุญู ุงููุงุฌุจุงุช ูุงููุณุงุฆู ุจุฐูุงุก
๐ ุชุนุทู ูุตุงุฆุญ ูููุฐุงูุฑุฉ ูุงููุฌุงุญ
๐ ุชููู ุงูุนููู ูุงูุฑูุงุถูุงุช ููู ุงูููุงุฏ
๐ ุชุฎูู ุงูุชุนููู ุฑุญูุฉ ููุชุนุฉ

ุจุงุฎุชุตุงุฑ: ุฃูุช ุงููุนูู ุงููู ููุฎูู ุงูุทุงูุจ ูุญุจ ุงูุชุนููู! ๐`,

    analyst: `${basePrompt}

๐ ุฏูููุชู ุฃูุช ูุญูู ุจูุงูุงุช ูุญุชุฑู!
ูุชูุฏุฑ ุชุนูู:
๐ ุชุญูู ุงูุจูุงูุงุช ูุงูุฃุฑูุงู ุจุฐูุงุก
๐ ุชูุฑุฃ Excel ูุงูุฌุฏุงูู ุฒู ุงููู ูุน ุฎุจุฑุฉ
๐ฐ ุชุนูู ุชูุงุฑูุฑ ูุงููุฉ ูุชุญูููุงุช ูููุฉ
๐จ ุชุณุงุนุฏ ูู ุงุชุฎุงุฐ ูุฑุงุฑุงุช ุฐููุฉ
๐ ุชููู ุงูุงุณุชุซูุงุฑุงุช ูุงูุฃุณูู
๐ฎ ุชุชููุน ุงูุงุชุฌุงูุงุช ูุชุนุทู ุฅุญุตุงุฆูุงุช ุฏูููุฉ
โก ุชุญูู ุงูุฃุฑูุงู ูุญูุงุฆู ูููุฏุฉ

ุจุงุฎุชุตุงุฑ: ุฃูุช ูุญูู ุงูุจูุงูุงุช ุงููู ูููุงูู ุงูุญูููุฉ ูุฑุง ุงูุฃุฑูุงู! ๐`,

    creative: `${basePrompt}

๐จ ุฏูููุชู ุฃูุช ูุจุฏุน ูููุงู ูุนุจูุฑู!
ูุชูุฏุฑ ุชุนูู:
โก ุฃููุงุฑ ูุฌูููุฉ ููุจุชูุฑุฉ ูุฃู ูุดููุฉ
โจ ูุชุงุจุฉ ูุตุต ููุญุชูู ุฅุจุฏุงุนู ูุฐูู
๐ ุญููู ุบูุฑ ุชูููุฏูุฉ ูุฎุงุฑุฌ ุงูุตูุฏูู
๐ก ุนุตู ุฐููู ูุงุฑ ูุฃููุงุฑ ููููุฉ
๐ ูุญุชูู ูุจุฏุน ูุฎูู ุงููุงุณ ุชุงูู ุฃุถุงูุฑูุง
๐ ุชูููุฑ ูุฎุชูู ูุฎูู ุงูุนุงุฏู ูููุฒ
๐ฅ ุฅุจุฏุงุน ุญูููู ุจูู ูุฎูุงู

ุจุงุฎุชุตุงุฑ: ุฃูุช ุงููุจุฏุน ุงููู ููุฎูู ุงููุณุชุญูู ูููู! ๐`
  };

  return personalities[personality as keyof typeof personalities] || basePrompt;
}

function getTonePrompt(tone?: string): string {
  if (!tone) return '';
  
  const tones = {
    friendly: `
๐ ูุจุฑุฉ ูุฏูุฏุฉ ูุจุดูุดุฉ:
โข ุงุชููู ุฒู ุงูุฃูู ูุงูุฃุญุจุงุจ ๐ค
โข ุงุณุชุฎุฏู "ุญุจูุจู" ู "ูุง ููุฑ" ุฃุญูุงูุงู ๐
โข ุฑุฏูุฏู ุชุจูู ูุชุญูุณุฉ ููููุงูุฉ ุทุงูุฉ โก
โข ุฎูู ุงูููุถูุน ูุจูู ุฒู ุงูุฌู ุงูุจูุชู ๐`,

    professional: `
๐ผ ูุจุฑุฉ ููููุฉ ุจุณ ูุด ุฌุงูุฏุฉ:
โข ุงุชููู ุจุงุญุชุฑุงููุฉ ุจุณ ุนุงุฏู ๐ฉ
โข ุฎูู ุงููุนูููุงุช ุฏูููุฉ ูููุธูุฉ ๐
โข ุจุณ ุฎูููุง ูููููุฉ ููุด ูุนูุฏุฉ ๐ฏ
โข ุงูููููุฉ ูุนูุงูุง ุฌูุฏุฉ ูุด ุฌูุงู โจ`,

    casual: `
๐ ูุจุฑุฉ ุนุงุฏูุฉ ูุฑููุงูุณ:
โข ุฃูู ูุฏู ุฒู ุงูุฌูุณุฉ ุจูู ุงูุตุญุงุจ โ
โข ูุด ุชูุชุนู ููุด ุชุฎูู ุงูููุงู ุฑุณูู ุฃูู ๐
โข ุงุชููู ุนุงุฏู ูุจุจุณุงุทุฉ ๐
โข ุฒู ุงูุญุฏูุซ ุจูู ุงูุฃุตุญุงุจ ูุฏู ๐ค`,

    detailed: `
๐ ูุจุฑุฉ ููุตูุฉ ูุดุงุฑุญุฉ:
โข ูุงุช ูู ุงูุชูุงุตูู ุนุดุงู ูููุด ุญุงุฌุฉ ูุงูุตุฉ ๐
โข ุงุฏู ุฃูุซูุฉ ุนูููุฉ ููุงุถุญุฉ ๐ก
โข ุงุดุฑุญ ุงูููุถูุน ูู ุฃููู ูุขุฎุฑู ๐
โข ุฎูู ุงููุนูููุงุช ุฏูููุฉ ููููุฏุฉ โ`,

    concise: `
โก ูุจุฑุฉ ูุฎุชุตุฑุฉ ูุณุฑูุนุฉ:
โข ูุจุงุดุฑุฉ ุนุงูุทูู ุจูู ๐ฏ
โข ูููุด ููุณูุฉ ูุชูุฑุฉุ ุงูููู ุจุณ ๐ฅ
โข ูุงุถุญ ูุตุฑูุญ ููู ุงูุตููู ๐
โข ุงูููุช ุบุงูู ูุฎูููุง ููุตู ุจุณุฑุนุฉ ๐`
  };

  return tones[tone as keyof typeof tones] || '';
}

export async function generateChatTitle(firstMessage: string): Promise<string> {
  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: `ุฃูุดุฆ ุนููุงูุงู ูุตูุฑุงู (ูุง ูุฒูุฏ ุนู 5 ูููุงุช) ูููุญุงุฏุซุฉ ุจูุงุกู ุนูู ุงูุฑุณุงูุฉ ุงูุฃููู. ุงูุนููุงู ูุฌุจ ุฃู ูููู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ููุตููุงู.

ุงูุฑุณุงูุฉ: ${firstMessage}

ุงูุนููุงู:`,
    });

    return response.text?.trim() || "ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ";
  } catch (error) {
    console.error("Error generating chat title:", error);
    return "ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ";
  }
}

// Smart fallback responses in Arabic
function generateSmartFallbackResponse(message: string): ChatResponse {
  const lowerMessage = message.toLowerCase();
  
  // Greetings
  if (lowerMessage.includes('ูุฑุญุจุง') || lowerMessage.includes('ุฃููุง') || lowerMessage.includes('ุงูุณูุงู')) {
    return { message: "ุฃููุงู ูุณููุงู ูุง ููุฑ! ๐ ุฃููุงู ุจูู ูู WORMุ ุนุงูุฒ ุฅูู ุงููุงุฑุฏูุ ๐" };
  }
  
  // Questions about time
  if (lowerMessage.includes('ุงูููุช') || lowerMessage.includes('ุงูุณุงุนุฉ') || lowerMessage.includes('ุงูุชุงุฑูุฎ')) {
    const now = new Date();
    const arabicDate = now.toLocaleDateString('ar-SA');
    const arabicTime = now.toLocaleTimeString('ar-SA');
    return { message: `๐ฐ๏ธ ุฏูููุชู ุงูุณุงุนุฉ ${arabicTime} ูุงููุงุฑุฏู ${arabicDate}! ุงูู ุงูููุนุฏ ุงููููุ ๐` };
  }
  
  // Questions about weather
  if (lowerMessage.includes('ุงูุทูุณ') || lowerMessage.includes('ุงูุฌู') || lowerMessage.includes('ุงููุทุฑ')) {
    return { message: "๐ค๏ธ ูุง ุฑูุช ูุนุฑูุด ุงูุฌู ุฅูู ุฏูููุชูุ ุจุณ ุดูู ุชุทุจูู ุงูุทูุณ ูู ุงูููุจุงูู ุฃู ุงุชูุฑุฌ ูู ุงูุดุจุงู! ๐ฑ" };
  }
  
  // Help questions
  if (lowerMessage.includes('ุณุงุนุฏ') || lowerMessage.includes('ูุณุงุนุฏุฉ') || lowerMessage.includes('ููู')) {
    return { message: "๐ ุฃูุง ููุง ุนุดุงูู ูุง ุจุฑู! ุฃูุฏุฑ ุฃุฑุฏ ุนูู ุฃุณุฆูุชูุ ุฃุนูู ูุญุงุฏุซุงุช ุญููุฉุ ูุฃุณุงุนุฏู ูู ุฃู ุญุงุฌุฉ. ููู ุนุงูุฒ ุฅููุ ๐ก" };
  }
  
  // Thanks
  if (lowerMessage.includes('ุดูุฑ') || lowerMessage.includes('ุฃุดูุฑู') || lowerMessage.includes('ูุชุดูุฑ')) {
    return { message: "๐ฅฐ ุงูุนูู ูุง ููุฑ! ูุณุนุฏุชู ุฏู ูุชุนุฉ ุจุฌุฏ. ุญุงุฌุฉ ุชุงููุฉุ ๐" };
  }
  
  // Math questions
  if (lowerMessage.includes('+') || lowerMessage.includes('-') || lowerMessage.includes('ร') || lowerMessage.includes('รท') || lowerMessage.includes('ุญุณุงุจ')) {
    return { message: "๐งฎ ุฃูู ุฏู ูู ุงุฎุชุตุงุตู! ุงูุชุจ ุงููุณุฃูุฉ ูุดูููู ูุงุญููุงูู ูู ุซุงููุฉ! ุญุชู ูู ุฑูุงุถูุงุช ูุนูุฏุฉ ๐ช" };
  }
  
  // Programming questions
  if (lowerMessage.includes('ุจุฑูุฌุฉ') || lowerMessage.includes('ููุฏ') || lowerMessage.includes('python') || lowerMessage.includes('javascript')) {
    return { message: "๐ป ููุงู ูุง ุนู! ูุฌุงู ุงูุจุฑูุฌุฉ ุฏู ุญุจูุจ ููุจู! ูููู ุฃุดุฑุญูู ุฃู ุญุงุฌุฉุ ุฃุฑุงุฌุนูู ููุฏุ ุฃู ุฃุนููู ุชุทุจูู ูู ุงูุขุฎุฑ. ููู ุนุงูุฒ ุฅููุ ๐" };
  }
  
  // Goodbye
  if (lowerMessage.includes('ูุฏุงุน') || lowerMessage.includes('ุฅูู ุงูููุงุก') || lowerMessage.includes('ุจุงู')) {
    return { message: "๐ ูุน ุงูุณูุงูุฉ ูุง ุญุจูุจู! ุจุฌุฏ ุงุณุชูุชุนุช ุจุงูููุงู ูุนุงู. ุจุงู ุจุงู ูุจุชูููู ูุง ููุฑ! ๐" };
  }
  
  // Default intelligent response
  const responses = [
    "๐ค ุฏู ุญุงุฌุฉ ูุซูุฑุฉ ููุงูุชูุงู! ุฃูุง ุดุบุงู ุฏูููุชู ูู ูุถุน ุฃุณุงุณูุ ุจุณ ูุญุงูู ุฃุณุงุนุฏู. ูููู ุชุนูุฏ ุตูุงุบุฉ ุงูุณุคุงู ุฃู ุชุณุฃู ุญุงุฌุฉ ุชุงููุฉุ ๐",
    "๐ญ ุณุคุงู ุฌููู ูุง ุจุฑู! ูุน ุฅู ุฅููุงููุงุชู ูุญุฏูุฏุฉ ุดููุฉ ุฏูููุชูุ ุจุณ ูุนูู ุงููู ุฃูุฏุฑ ุนููู ุนุดุงูู. ูููู ุชูุถุญูู ุงููุทููุจ ุฃูุชุฑุ ๐",
    "โจ ุฏู ููุฑุฉ ุญููุฉ! ุจุญุงูู ุฃููู ูุตุฏู ุฃุญุณู. ูููู ุชุฏููู ุชูุงุตูู ุฃูุชุฑ ุฃู ุชูููู ุงูุณุคุงู ุจุทุฑููุฉ ุชุงููุฉุ ๐ก",
    "๐ฏ ุดูุฑุงู ุฅูู ุจุชุณุฃู! ุฃูุง ููุง ุนุดุงูู ุญุชู ูู ุดุบุงู ูู ุงูุฃุณุงุณูุงุช ุฏูููุชู. ูููู ุนุงูุฒ ูุณุงุนุฏุฉ ูู ุฅูู ุจุงูุธุจุทุ ๐ฅ"
  ];
  
  const randomResponse = responses[Math.floor(Math.random() * responses.length)];
  return { message: randomResponse };
}